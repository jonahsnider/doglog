import markdoc from '@astrojs/markdoc';
import starlight from '@astrojs/starlight';
import { defineConfig } from 'astro/config';
import fs from 'fs/promises';
import path from 'path';
import starlightLinksValidator from 'starlight-links-validator';

// https://astro.build/config
export default defineConfig({
	site: 'https://doglog.dev',
	integrations: [
		{
			name: 'copy-files',
			hooks: {
				'astro:config:setup': async () => {
					await Promise.all([writeChangelogToContent(), copyVendordep()]);
				},
			},
		},
		starlight({
			plugins: [starlightLinksValidator()],
			title: 'DogLog Docs',
			favicon: '/favicon.ico',
			social: {
				github: 'https://github.com/jonahsnider/doglog',
			},
			logo: {
				alt: 'DogLog logo',
				src: './src/assets/logo.svg',
			},
			sidebar: [
				{
					label: 'Getting started',
					autogenerate: { directory: 'getting-started' },
				},
				{
					label: 'Guides',
					autogenerate: { directory: 'guides' },
				},
				{
					label: 'Reference',
					autogenerate: { directory: 'reference' },
				},
				{
					label: 'Javadoc',
					link: 'https://javadoc.doglog.dev',
				},
			],
			customCss: ['/src/styles/custom.css'],
		}),
		markdoc(),
	],
});

async function writeChangelogToContent() {
	const CHANGELOG_INPUT_PATH = path.join(import.meta.dirname, '..', 'CHANGELOG.md');
	const OUTPUT_PATH = path.join(import.meta.dirname, 'src', 'content', 'docs', 'reference', 'changelog.md');

	const rawChangelog = await fs.readFile(CHANGELOG_INPUT_PATH, 'utf-8');

	const newChangelog =
		[
			'---',
			'# AUTOGENERATED - see astro.config.mjs',
			'title: Changelog',
			'description: Changelog of updates to DogLog.',
			'---',
			'',
		].join('\n') + rawChangelog.replace('# Changelog', '');

	await fs.writeFile(OUTPUT_PATH, newChangelog);
}

async function copyVendordep() {
	const VENDORDEP_INPUT_PATH = path.join(import.meta.dirname, '..', 'vendordep.json');
	const OUTPUT_PATH = path.join(import.meta.dirname, 'public', 'vendordep.json');

	await fs.copyFile(VENDORDEP_INPUT_PATH, OUTPUT_PATH);
}
